1 = Encrypting Data At Rest
2 
3 == Encryption Levels
4 
5 The TigerGraph graph data store uses a proprietary encoding scheme which both compresses the data and obscures the data unless the user knows the encoding/decoding scheme. In addition, the TigerGraph system supports integration with industry-standard methods for encrypting data when stored in disk ("data at rest").
6 
7 Data at rest encryption can be applied at many different levels. A user can choose to use one or more level.
8 
9 |===
10 | Encryption Level | Description | TigerGraph Support
11 
12 | Hardware
13 | Use specialized hard disks which perform automatic  encryption on write and decryption on read (by  authorized OS users)
14 | Invisible to TigerGraph
15 
16 | Kernel-level file system
17 | Use Linux built-in utilities to encrypt data.  Root privilege required.
18 | Invisible to TigerGraph
19 
20 | User-level file system
21 | Use Linux built-in utilities and customized libraries to encrypt data.  Root privilege is not required.
22 | Invisible to TigerGraph
23 |===
24 
25 === Kernel-level Encryption
26 
27 File system encryption employs advanced encryption algorithms. Some tools allow the user to select from a menu of encryption algorithms. It can be done either in kernel mode or user mode. To run in kernel mode, superuser  permission is required.
28 
29 Since Linux 2.6,  device-mapper has been an infrastructure, which provides a generic way to create virtual layers of block devices with transparent encryption blocks using the kernel crypto API.
30 
31 In Ubuntu, full-disk encryption is an option during the OS installation process. For other Linux distributions, the disk can be encrypted with https://wiki.archlinux.org/index.php/Dm-crypt[dm-encrypt].
32 
33 A commonly used utility is http://ecryptfs.org/[eCryptfs], which is licensed under GPL, and it is built into some kernels, such as Ubuntu.
34 
35 === User-Level Encryption
36 
37 If root privilege is not available, a workaround is to use FUSE (Filesystem in User Space) to create a user-level filesystem running on top of the host operating system. While the performance may not be as good as running in kernel mode, there are more options available for customization and tuning.
38 
39 == Example 1: Kernel-mode file system encryption with dm-crypt
40 
41 In this example, we use dm-crypt to provide kernel-mode file system encryption. The dm-crypt utility is widely available and offers a choice of encryption algorithms. It also can be set to encrypt various units of storage -- full disk, partitions, logical volumes, or files.
42 
43 The basic idea of this solution is to create a file, map an encrypted file system to it, and mount it as a storage directory for TigerGraph with R/W permission only to authorized users.
44 
45 === Prerequisites
46 
47 Before you start, you will need a Linux machine on which
48 
49 * you have root permission,
50 * the TigerGraph system has not yet been installed,
51 * and you have sufficient disk space for the TigerGraph data you wish to encrypt. This may be on your local disk or on a separate disk you have mounted.
52 
53 === Instructions
54 
55 * Install cryptsetup (cryptsetup is included with Ubuntu, but other OS users may need to install it with yum).
56 * Install the TigerGraph system.
57 * Grant sudo privilege to the TigerGraph OS user.
58 * Stop all TigerGraph services with the following commands:  gadmin stop all -y  gadmin stop admin -y
59 * Acting as the tigergraph OS user, run the following export commands to set variables. Replace the placeholders enclosed in angle brackets <...> with the values of your choice:
60 
61 [source,bash]
62 ----
63 # The username for TigerGraph Database System, for example: tigergraph
64 export db_user='<username>'
65 
66 # The path of encrypted file to be created for TigerGraph storage, for example: /home/tigergraph/secretfs
67 export encrypted_file_path='<path-to-encrypted-file>'
68 
69 # The size of encrypted file to be created (used by dd command), for example: 60G
70 export encrypted_file_size=<storage-size>
71 
72 # The password for the encrypted file, for example: DataAtRe5tPa55w0rd
73 export encryption_password='<password>'
74 
75 # The root directory for tigergraph, for example: $HOME/tigergraph
76 export tigergraph_data_root="<tigergraph-data-root>"
77 
78 # Set the first available loop device for encrypted file mapping
79 export loop_device=$(losetup -f)
80 ----
81 
82 * Create a file for TigerGraph data storage.
83 
84 [source,bash]
85 ----
86 dd of=$encrypted_file_path bs=$encrypted_file_size count=0 seek=1
87 ----
88 
89 * Change the permission of the file so that only the owner of the file (that is, only the tigergraph user who created the file in the previous step) will be able to access it:
90 
91 [source,bash]
92 ----
93 chmod 600 $encrypted_file_path
94 ----
95 
96 * Associate a loopback device with the file:
97 
98 [source,bash]
99 ----
100 sudo losetup $loop_device $encrypted_file_path
101 ----
102 
103 * Encrypt storage in the device. cryptsetup will use the Linux device mapper to create, in this case, $encrypted_file_path . Initialize the volume and set a password interactively with the password you set to $encryption_password :
104 
105 [source,bash]
106 ----
107 sudo cryptsetup -y luksFormat $loop_device
108 ----
109 
110 If you are trying to automate the process with a script running with root TTY session , you may use the following command:
111 
112 [source,bash]
113 ----
114 echo "$encryption_password" | cryptsetup -y luksFormat $loop_device
115 ----
116 
117 * Open the partition, and create a mapping to $encrypted_file_path :
118 
119 [source,bash]
120 ----
121 sudo cryptsetup luksOpen $loop_device tigergraph_gstore
122 ----
123 
124 If you are trying to automate the process with a script running with root TTY session , you may use the following command:
125 
126 [source,bash]
127 ----
128 echo "$encryption_password" | cryptsetup luksOpen $loop_device tigergraph_gstore
129 ----
130 
131 * Clear the password from bash variables and bash history.
132 
133 [CAUTION]
134 ====
135 The following commands may clear your previous bash histories as well. Instead, you may edit ~/.bash_history to selectively delete the related entries.
136 ====
137 
138 [source,bash]
139 ----
140 unset encryption_password
141 history -c
142 history -w
143 ----
144 
145 * Create a file system and verify its status:
146 
147 [source,bash]
148 ----
149 sudo mke2fs -j -O dir_index /dev/mapper/tigergraph_gstore
150 ----
151 
152 * Mount the new file system to /mnt/secretfs:
153 
154 [source,bash]
155 ----
156 sudo mkdir -p /mnt/secretfs
157 sudo mount /dev/mapper/tigergraph_gstore /mnt/secretfs
158 ----
159 
160 * Change the permission to 700 so that only $db_user has access to the file system:
161 
162 [source,bash]
163 ----
164 sudo chmod -R 700 /mnt/secretfs
165 sudo chown -R $db_user:$db_user /mnt/secretfs
166 ----
167 
168 * Move the original TigerGraph files to the encrypted filesystem and make a symbolic link. If you wish to encrypt only the TigerGraph data store (called gstore), use the following commands:
169 
170 [source,bash]
171 ----
172 mv $tigergraph_data_root/gstore /mnt/secretfs/gstore
173 ln -s /mnt/secretfs/gstore $tigergraph_data_root/gstore
174 ----
175 
176 There are other TigerGraph files which you might also consider to be sensitive and wish to encrypt.  These include the dictionary, kafka data files, and log files.  You could selectively identify files to protect or you could encrypt the entire TigerGraph folder(App/Data/Log/TempRoot). In this case, simply move  $tigergraph_data_root instead of $tigergraph_data_root/gstore.
177 
178 [source,bash]
179 ----
180 mv $tigergraph_data_root /mnt/secretfs/tigergraph
181 ln -s /mnt/secretfs/tigergraph $tigergraph_data_root
182 ----
183 
184 The data of TigerGraph data is now stored in an encrypted filesystem.  It will be automated decrypted when the tigergraph user (and only this user) accesses it.
185 
186 To automatically deploy this encryption solution, you may
187 
188 . Chain all the steps as a bash script
189 . Remove all "sudo" since the script will be running as root.
190 . Run the script as root user after TigerGraph Installation.
191 
192 [CAUTION]
193 ====
194 The setup scripts contain your encryption password. To follow good security procedures, do not leave your password in plaintext format in any files on your disk. Either remove the setup scripts or edit out the password.
195 ====
196 
197 === Performance Evaluation
198 
199 Encryption is usually CPU-bound rather than I/O-bound. If CPU usage reamains below 100%, encryption should not cause much  performance slowdown. A performance test using both small and large queries supports this prediction: for small (~1 sec) and large (~100 sec) queries, there is a ~5% slowdown due to filesystem encryption.
200 
201 |===
202 |  | *GSE Cold Start (read)* | *Load Data (write)*
203 
204 | original
205 | 45s
206 | 809s
207 
208 | encrypted
209 | 47s
210 | 854s
211 
212 | % slowdown
213 | 4.4%
214 | 5.8%
215 |===
216 
217 We used the TPC-H dataset with scale factor 10 ( http://www.tpc.org/tpch/). The data size is 23GB after loading into TigerGraph..The write test (data loading) was done by running a loading job and then killing the GPE with SIGTERM (to exit gracefully) to ensure that all kafka data is consumed.The read test (GSE cold start) measures the time from "gadmin start gse" until "online" appears in "gadmin status gse".
218 
219 == Example 2: Encrypting Data on Amazon EC2
220 
221 Major cloud service providers often provide their own methodologies for encrypting data at rest. For Amazon EC2, we recommend users start by reading the AWS Security Blog: https://aws.amazon.com/blogs/security/how-to-protect-data-at-rest-with-amazon-ec2-instance-store-encryption/[How to Protect Data at Rest with Amazon EC2 Instance Store Encryption].
222 
223 In this section, we provide a simple example for configuring file system encryption for a TigerGraph running on Amazon EC2. The steps are based on those given in https://aws.amazon.com/blogs/security/how-to-protect-data-at-rest-with-amazon-ec2-instance-store-encryption/[How to Protect Data at Rest with Amazon EC2 Instance Store Encryption], with some additions and modifications.
224 
225 The basic idea of this solution is to create a file, map an encrypted file system to it, and mount it as a storage directory for TigerGraph with permission only to authorized users.
226 
227 [WARNING]
228 ====
229 Angle brackets <...> are used to mark placeholders which you should replace with your own values (without the angle brackets).
230 ====
231 
232 === *Prerequisites*
233 
234 Make sure you have installed and configured https://aws.amazon.com/cli/[AWS CLI]with keys locally.
235 
236 === *Create an S3 Bucket*
237 
238 .from Amazon Data-at-Rest blog
239 
240 [source,text]
241 ----
242 Sign in to the S3 console and choose Create Bucket .
243 In the Bucket Name box, type your bucket name and then choose Create .
244 You should see the details about your new bucket in the right pane.
245 ----
246 
247 
248 
249 === *Configure IAM roles and permission for the S3 bucket*
250 
251 .from Amazon Data-at-Rest blog
252 
253 [source,javascript]
254 ----
255 1.Sign in to the AWS Management Console and navigate to the IAM console . In the navigation pane, choose Policies , choose Create Policy . Choose the JSON tab, paste in the following JSON code, and then choose Review Policy . Name and describe the policy, and then choose Create Policy to save your work. For more details, see Creating Customer Managed Policies .
256 
257 {
258     "Version": "2012-10-17",
259     "Statement": [
260         {
261             "Sid": "VisualEditor0",
262             "Effect": "Allow",
263             "Action": "s3:GetObject",
264             "Resource": "arn:aws:s3:::<your-bucket-name>/LuksInternalStorageKey"
265         }
266     ]
267 }
268 The preceding policy grants read access to the bucket where the encrypted password is stored. This policy is used by the EC2 instance, which requires you to configure an IAM role. You will configure KMS permissions later in this post.
269 (The following instructions have been updated since the original blog post.)
270 
271 2."Select type of trusted entity: Choose AWS service .
272 3."Select the service that will use this role": Choose EC2 then choose Next: Permissions.
273 4.Choose the policy you created in Step 1 and then choose Next: Review.
274 5.On the Create role page, type your role name , a Role description, and choose Create role .
275 6.The newly created IAM role is now ready. You will use it when launching new EC2 instances, which will have the permission to access the encrypted password file in the S3 bucket.
276 ----
277 
278 
279 
280 === Create a KMS Key (optional)
281 
282 If you don't have a KMS key, you can create it first:
283 
284 . From the https://console.aws.amazon.com/iam/home[IAM console], choose Encryption keys from the navigation pane.
285 . Select Create Key , and type in <your-key-alias> _**_
286 . For Step 2 and Step 3 , see https://docs.aws.amazon.com/kms/latest/developerguide/create-keys.htmlfor advice.
287 . In Step 4 : Define Key Usage Permissions , select <your-role-name>
288 . The role now has permission to use the key.
289 
290 image::screen-shot-2018-10-01-at-11.20.59-pm.png[Step 2. Create Key]
291 
292 === Encrypt a secret password with KMS and store it in the S3 bucket
293 
294 .from Amazon Data-at-Rest blog
295 
296 [source,text]
297 ----
298 Next, use KMS to encrypt a secret password. To encrypt text by using KMS, you must use AWS CLI . AWS CLI is installed by default on EC2 Amazon Linux instances and you can install it on Linux, Windows, or Mac computers.
299 
300 To encrypt a secret password with KMS and store it in the S3 bucket:
301 
302 From the AWS CLI, type the following command to encrypt a secret password by using KMS (replace <your-region> with your region). You must have the right permissions in order to create keys and put objects in S3 (for more details, see Using IAM Policies with AWS KMS ). In this example, I have used AWS CLI on the Linux OS to encrypt and generate the encrypted password file.
303 aws --region <your-region> kms encrypt --key-id 'alias/<your-key-alias>' --plaintext '<your-password>' --query CiphertextBlob --output text | base64 --decode > LuksInternalStorageKey
304 
305 aws s3 cp LuksInternalStorageKey s3://<your-bucket-name>/LuksInternalStorageKey
306 The preceding commands encrypt the password (Base64 is used to decode the cipher text). The command outputs the results to a file called LuksInternalStorageKey. It also creates a key alias (key name) that makes it easy to identify different keys; the alias is called <your-key-alias> . The file is then copied to the S3 bucket created earlier in this post.
307 ----
308 
309 
310 
311 === Configure EC2 with role and launch configurations
312 
313 In this section, you launch a new EC2 instance with the new IAM role and a bootstrap script that executes the steps to encrypt the file system.
314 
315 [WARNING]
316 ====
317 The script in this section requires root permission, and it cannot be run manually through an ssh tunnel or by an unprivileged user.
318 ====
319 
320 image::13.2.png[]
321 
322 . In the https://console.aws.amazon.com/ec2/v2/home[EC2 console], launch a new instance (see http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/launching-instance.html[this tutorial]for more details). Amazon Linux AMI 2017.09.1 (HVM), SSD Volume Type (If NOT using Amazon Linux AMI, a script the installs python, pip and AWS CLI needs to be added in the beginning).
323 . In Step 3: Configure Instance Details
324  .. In IAM role , choose <your-role-name>
325  .. In User Data , paste the following code block after replacing the placeholders with your values and appending TigerGraph installation script
326 
327 .Encryption bootstrap script
328 
329 [source,bash]
330 ----
331 #!/bin/bash
332 
333 db_user=tigergraph
334 
335 ## Initial setup to be executed on boot
336 ##====================================
337 # Create an empty file. This file will be used to host the file system.
338 # In this example we create a <disk-size> (for example: 60G) file at <path-to-encrypted-file> (for example: /home/tigergraph/gstore_enc).
339 dd of=<path-to-encrypted-file> bs=<disk-size> count=0 seek=1
340 
341 # Lock down normal access to the file.
342 chmod 600 <path-to-encrypted-file>
343 
344 # Associate a loopback device with the file.
345 losetup /dev/loop0 <path-to-encrypted-file>
346 
347 #Copy encrypted password file from S3. The password is used to configure LUKE later on.
348 aws s3 cp s3://<your-bucket-name>/LuksInternalStorageKey .
349 
350 # Decrypt the password from the file with KMS, save the secret password in LuksClearTextKey
351 LuksClearTextKey=$(aws --region <your-region> kms decrypt --ciphertext-blob fileb://LuksInternalStorageKey --output text --query Plaintext | base64 --decode)
352 
353 # Encrypt storage in the device. cryptsetup will use the Linux
354 # device mapper to create, in this case, /dev/mapper/tigergraph_gstore.
355 # Initialize the volume and set an initial key.
356 echo "$LuksClearTextKey" | cryptsetup -y luksFormat /dev/loop0
357 
358 # Open the partition, and create a mapping to /dev/mapper/tigergraph_gstore.
359 echo "$LuksClearTextKey" | cryptsetup luksOpen /dev/loop0 tigergraph_gstore
360 
361 # Clear the LuksClearTextKey variable because we don't need it anymore.
362 unset LuksClearTextKey
363 
364 # Create a file system and verify its status.
365 mke2fs -j -O dir_index /dev/mapper/tigergraph_gstore
366 
367 # Mount the new file system to /mnt/secretfs.
368 mkdir -p /mnt/secretfs
369 mount /dev/mapper/tigergraph_gstore /mnt/secretfs
370 
371 # create user tigergraph
372 adduser $db_user
373 
374 # Change the permission so that only tigergraph has access to the file system
375 chmod -R 700 /mnt/secretfs
376 chown -R $db_user:$db_user /mnt/secretfs
377 
378 # Install TigerGraph
379 # Run the one-command installation script with TigerGraphh root path under /mnt/secretfs
380 ----
381 
382 
383 
384 It may take a few minutes for the script to complete after system launch.
385 
386 Then, you should be able to launch one or more EC2 machines with an encrypted folder under /mnt/secretfs that only OS user _tigergraph_ can access.
387 
388 === Performance
389 
390 Encryption is usually CPU-bound rather than I/O bound. If CPU usage is below 100%, TigerGraph tests show no significant performance downgrade.

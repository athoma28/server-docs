1 = Backup and Restore
2 :description: GBAR - Graph Backup and Restore
3 :pp: {plus}{plus}
4 
5 Graph Backup And Restore (GBAR), is an integrated tool for backing up and restoring the data and data dictionary (schema, loading jobs, and queries) of a TigerGraph instance or cluster.
6 
7 The backup feature packs TigerGraph data and configuration information into a directory on the local disk or a remote AWS S3 bucket. Multiple backup files can be archived. Later, you can use the restore feature to roll back the system to any backup point. This tool can also be integrated easily with Linux cron to perform periodic backup jobs.
8 
9 == Syntax
10 
11 [NOTE]
12 ====
13 The current version of GBAR is intended for restoring the same machine that was backed up. For help with cloning a database (i.e., backing up machine A and restoring the database to machine B), please contact link:mailto:support@tigergraph.com[support@tigergraph.com].
14 ====
15 
16 .Synopsis
17 
18 [source,text]
19 ----
20 Usage: gbar backup [options] -t <backup_tag>
21 		      gbar restore [options] <backup_tag>
22 		      gbar list [backup_tag] [-j]
23 		      gbar remove|rm <backup_tag>
24 		      gbar cleanup
25 		      gbar expand [-a] <new_nodes>
26 		           New nodes must be written in <name>:<host> pairs separated by comma
27 		           Example:
28 		               m1:192.168.1.2,m2:192.168.1.3,m3:192.168.1.4
29 
30 		Options:
31 		 -h, --help     	Show this help message and exit
32 		 -v             	Run with debug info dumped
33 		 -vv            	Run with verbose debug info dumped
34 		 -y             	Run without prompt
35 		 -j            		Print gbar list as JSON
36 		 -t BACKUP_TAG  	Tag for backup file, required on backup
37 		 -a, --advanced    Enable advanced mode for node expansion
38 ----
39 
40 
41 
42 The `-y` option forces GBAR to skip interactive prompt questions by selecting the default answer. There is currently one interactive question:
43 
44 * At the start of restore, GBAR will always ask if it is okay to stop and reset the TigerGraph services: (y/N)? The default answer is yes.
45 
46 == Configure GBAR
47 
48 Before using the backup or the restore feature, GBAR must be configured.
49 
50 . Run `gadmin config entry system.backup`. At each prompt, enter the appropriate values for each config parameter.
51 +
52 [source,bash]
53 ----
54 $ gadmin config entry system.backup
55 
56 System.Backup.TimeoutSec [ 18000 ]: The backup timeout in seconds
57 New: 18000
58 
59 System.Backup.CompressProcessNumber [ 8 ]: The number of concurrent process for compression during backup
60 New: 8
61 
62 System.Backup.Local.Enable [ true ]: Backup data to local path
63 New: true
64 
65 System.Backup.Local.Path [ /tmp/backup ]: The path to store the backup files
66 New: /data/backup
67 
68 System.Backup.S3.Enable [ false ]: Backup data to S3 path
69 New: false
70 
71 System.Backup.S3.AWSAccessKeyID [ <masked> ]: The path to store the backup files
72 New:
73 
74 System.Backup.S3.AWSSecretAccessKey [ <masked> ]: The path to store the backup files
75 New:
76 
77 System.Backup.S3.BucketName [  ]: The path to store the backup files
78 New:
79 ----
80 
81 . After entering the configuration values, run the following command to apply the new configurations
82 +
83 [source,text]
84 ----
85 gadmin config apply -y
86 ----
87 
88 *Note*:
89 
90 * For S3 configuration, the AWS access key and secret are not provided, then GBAR will use the attached IAM role.
91 * You can specify the number of parallel processes for backup and restore.
92 * You must provide username and password using GSQL_USERNAME and GSQL_PASSWORD environment variables.
93 
94  $ GSQL_USERNAME=tigergraph GSQL_PASSWORD=tigergraph gbar backup -t daily
95 
96 == Perform a backup
97 
98 To perform a backup, run the following command as the TigerGraph Linux user:
99 
100 [source,text]
101 ----
102 gbar backup -t <backup_tag>
103 ----
104 
105 Depending on your configuration settings, your backup archive will be output to your local backup path and/or your AWS S3 bucket. If you are running a cluster, there will be a backup archive on every node in the same path.
106 
107 A backup archive is stored as several files in a folder, rather than as a single file. The backup tag acts like a filename prefix for the archive filename. The full name of the backup archive will be `<backup_tag>-<timestamp>`, which is a subfolder of the backup repository.
108 
109 * If `System.Backup.Local.Enable` is set to `true`, the folder is a local folder on every node in a cluster, to avoid massive data moving across nodes in a cluster.
110 * If `System.Backup.S3.Enable` is set to `true`, every node will upload data located on the node to the s3 repository. Therefore, every node in a cluster needs access to Amazon S3. If IAM policy is used for authentication, every node in the cluster needs to be given access under the IAM policy.
111 
112 GBAR Backup performs a live backup, meaning that normal operations may continue while the backup is in progress. When GBAR backup starts, GBAR will check if there are running loading jobs. If there are, it will pause loading for 1 minute to generate a snapshot and then continue the backup process. You can specify the loading pausing interval by the environment variable `PAUSE_LOADING`.
113 
114 GBAR then sends a request to the admin server, which then requests the GPE and GSE to create snapshots of their data. Per the request, the GPE and GSE store their data under GBAR's own working directory. GBAR also directly contacts the Dictionary and obtains a dump of its system configuration information. In addition, GBAR gathers the TigerGraph system version and customized information including user-defined functions, token functions, schema layouts and user-uploaded icons. Then, GBAR compresses each of these data and configuration information files in tgz format and stores them in the `<backup_tag>-<timestamp>` subfolder on each node. As the last step, GBAR copies that file to local storage or AWS S3, according to the Config settings, and removes all temporary files generated during backup.
115 
116 The current version of GBAR Backup takes snapshots quickly to make it very likely that all the components (GPE, GSE, and Dictionary) are in a consistent state, but it does not fully guarantee consistency.
117 
118 [WARNING]
119 ====
120 Backup does not save input message queues for REST{pp} or Kafka.
121 ====
122 
123 == List Backup Files
124 
125 [source,text]
126 ----
127 gbar list
128 ----
129 
130 This command lists all generated backup files in the storage place configured by the user. For each file, it shows the file's full tag, its size in human-readable format, and its creation time.
131 
132 == Restore from a backup archive
133 
134 Before restoring a backup, you should ensure that the backup you are restoring from is in the *same exact version* as your current version of TigerGraph.
135 
136 To restore a backup, run the following command:
137 
138 [source,text]
139 ----
140 gbar restore <archive_name>
141 ----
142 
143 If GBAR can verify that the backup archive exists and that the backup's system version is compatible with the current system version, GBAR will shut down the TigerGraph servers temporarily as it restores the backup. After completing the restore, GBAR will restart the TigerGraph servers. If you are running a cluster, and you have copied the backup files to each individual node in the cluster, running `gbar restore` on any node will restore the entire cluster.
144 
145 Restore is an offline operation, requiring the data services to be temporarily shut down. The user must specify the full archive name ( `<backup_tag>-<timestamp>` ) to be restored. When GBAR restore begins, it first searches for a backup archive exactly matching the archive name supplied in the command line. Then it decompresses the backup files to a working directory. Next, GBAR will compare the TigerGraph system version in the backup archive with the current system's version, to make sure that the backup archive is compatible with that current system. It will then shut down the TigerGraph servers (GSE, RESTPP, etc.) temporarily. Then, GBAR makes a copy of the current graph data, as a precaution. Next, GBAR copies the backup graph data into the GPE and GSE and notifies the Dictionary to load the configuration data. Also, GBAR will notify the GST to load backup user data and copy the backup user-defined token/functions to the right location. When these actions are all done, GBAR will restart the TigerGraph servers.
146 
147 NOTE: GBAR restore does not estimate the uncompressed data size and check whether there is sufficient disk space.
148 
149 [NOTE]
150 ====
151 The primary purpose of GBAR is to save snapshots of the data configuration of a TigerGraph system, so that in the future the same system can be rolled back (restored) to one of the saved states. A key assumption is that Backup and Restore are performed on the same machine, and that the file structure of the TigerGraph software has not changed.
152 ====
153 
154 [WARNING]
155 ====
156 Restore needs enough free space to accommodate both the old gstore and the gstore to be restored.
157 ====
158 
159 == Remove a backup
160 
161 To remove a backup, run the `gbar remove` command:
162 
163 [source,text]
164 ----
165 $ gbar remove <backup_tag>
166 ----
167 
168 The command removes a backup from the backup storage path. To retrieve the tag of a backup, you can use the `gbar list` command.
169 
170 == Clean up temporary files
171 
172 Run `gbar cleanup` to delete the temporary files created during backup or restore operations:
173 
174 [source,text]
175 ----
176 $ gbar cleanup
177 ----
178 
179 == GBAR Detailed Example
180 
181 The following example describes a real example, to show the actual commands, the expected output, and the amount of time and disk space used, for a given set of graph data. For this example, an Amazon EC2 instance was used, with the following specifications:
182 
183 Single instance with 32 vCPU + 244GB memory + 2TB HDD.
184 
185 Naturally, backup and restore time will vary depending on the hardware used.
186 
187 === GBAR Backup Operational Details
188 
189 To run a daily backup, we tell GBAR to backup with the tag name _daily_.
190 
191 [source,text]
192 ----
193 $ gbar backup -t daily
194 [23:21:46] Retrieve TigerGraph system configuration
195 [23:21:51] Start workgroup
196 [23:21:59] Snapshot GPE/GSE data
197 [23:33:50] Snapshot DICT data
198 [23:33:50] Calc checksum
199 [23:37:19] Compress backup data
200 [23:46:43] Pack backup data
201 [23:53:18] Put archive daily-20180607232159 to repo-local
202 [23:53:19] Terminate workgroup
203 Backup to daily-20180607232159 finished in 31m33s.
204 ----
205 
206 The total backup process took about 31 minutes, and the generated archive is about 49 GB. Dumping the GPE + GSE data to disk took 12 minutes. Compressing the files took another 20 minutes.
207 
208 === GBAR Restore Operational Details
209 
210 To restore from a backup archive, a full archive name needs to be provided, such as _daily-20180607232159_. By default, restore will ask the user to approve to continue. If you want to pre-approve these actions, use the "-y" option. GBAR will make the default choice for you.
211 
212 [source,text]
213 ----
214 $ gbar restore daily-20180607232159
215 [23:57:06] Retrieve TigerGraph system configuration
216 GBAR restore needs to reset TigerGraph system.
217 Do you want to continue?(y/N):y
218 [23:57:13] Start workgroup
219 [23:57:22] Pull archive daily-20180607232159, round #1
220 [23:57:57] Pull archive daily-20180607232159, round #2
221 [00:01:00] Pull archive daily-20180607232159, round #3
222 [00:01:00] Unpack cluster data
223 [00:06:39] Decompress backup data
224 [00:17:32] Verify checksum
225 [00:18:30] gadmin stop gpe gse
226 [00:18:36] Snapshot DICT data
227 [00:18:36] Restore cluster data
228 [00:18:36] Restore DICT data
229 [00:18:36] gadmin reset
230 [00:19:16] gadmin start
231 [00:19:41] reinstall GSQL queries
232 [00:19:42] recompiling loading jobs
233 [00:20:01] Terminate workgroup
234 Restore from daily-20180607232159 finished in 22m55s.
235 Old gstore data saved under /home/tigergraph/tigergraph/gstore with suffix -20180608001836, you need to remove them manually.
236 ----
237 
238 For our test, GBAR restore took about 23 minutes. Most of the time (20 minutes) was spent decompressing the backup archive.
239 
240 Note that after the restore is done, GBAR informs you were the pre-restore graph data (gstore) has been saved. After you have verified that the restore was successful, you may want to delete the old gstore files to free up disk space.
241 
242 === Performance Summary of Example
243 
244 |===
245 | GStore size | Backup file size | Backup time | Restore time
246 
247 | 219GB
248 | 49GB
249 | 31 mins
250 | 23 mins
251 |===
